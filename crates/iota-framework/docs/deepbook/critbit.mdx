---
title: Module `0xdee9::critbit`
---
import Link from '@docusaurus/Link';

<Link id="0xdee9_critbit"/>


-  [Struct `Leaf`](#0xdee9_critbit_Leaf)
-  [Struct `InternalNode`](#0xdee9_critbit_InternalNode)
-  [Struct `CritbitTree`](#0xdee9_critbit_CritbitTree)
-  [Constants](#@Constants_0)
-  [Function `new`](#0xdee9_critbit_new)
-  [Function `size`](#0xdee9_critbit_size)
-  [Function `is_empty`](#0xdee9_critbit_is_empty)
-  [Function `min_leaf`](#0xdee9_critbit_min_leaf)
-  [Function `max_leaf`](#0xdee9_critbit_max_leaf)
-  [Function `previous_leaf`](#0xdee9_critbit_previous_leaf)
-  [Function `next_leaf`](#0xdee9_critbit_next_leaf)
-  [Function `left_most_leaf`](#0xdee9_critbit_left_most_leaf)
-  [Function `right_most_leaf`](#0xdee9_critbit_right_most_leaf)
-  [Function `insert_leaf`](#0xdee9_critbit_insert_leaf)
-  [Function `find_leaf`](#0xdee9_critbit_find_leaf)
-  [Function `find_closest_key`](#0xdee9_critbit_find_closest_key)
-  [Function `remove_leaf_by_index`](#0xdee9_critbit_remove_leaf_by_index)
-  [Function `borrow_mut_leaf_by_index`](#0xdee9_critbit_borrow_mut_leaf_by_index)
-  [Function `borrow_leaf_by_index`](#0xdee9_critbit_borrow_leaf_by_index)
-  [Function `borrow_leaf_by_key`](#0xdee9_critbit_borrow_leaf_by_key)
-  [Function `drop`](#0xdee9_critbit_drop)
-  [Function `destroy_empty`](#0xdee9_critbit_destroy_empty)
-  [Function `get_closest_leaf_index_by_key`](#0xdee9_critbit_get_closest_leaf_index_by_key)
-  [Function `update_child`](#0xdee9_critbit_update_child)
-  [Function `is_left_child`](#0xdee9_critbit_is_left_child)


<pre><code>
<b>use</b> <Link to="../iota-framework/table#0x2_table">0x2::table</Link>;
<b>use</b> <Link to="../iota-framework/tx_context#0x2_tx_context">0x2::tx_context</Link>;
<b>use</b> <Link to="math#0xdee9_math">0xdee9::math</Link>;
</code></pre>



<Link id="0xdee9_critbit_Leaf"></Link>

## Struct `Leaf`



<pre><code>
<b>struct</b> <Link to="critbit#0xdee9_critbit_Leaf">Leaf</Link>&lt;V&gt; <b>has</b> drop, store
</code></pre>



<details>
<summary>Fields</summary>


<dl>
<dt>
<code>
key: u64</code>
</dt>
<dd>

</dd>
<dt>
<code>
value: V</code>
</dt>
<dd>

</dd>
<dt>
<code>
parent: u64</code>
</dt>
<dd>

</dd>
</dl>


</details>

<Link id="0xdee9_critbit_InternalNode"></Link>

## Struct `InternalNode`



<pre><code>
<b>struct</b> <Link to="critbit#0xdee9_critbit_InternalNode">InternalNode</Link> <b>has</b> drop, store
</code></pre>



<details>
<summary>Fields</summary>


<dl>
<dt>
<code>
mask: u64</code>
</dt>
<dd>

</dd>
<dt>
<code>
left_child: u64</code>
</dt>
<dd>

</dd>
<dt>
<code>
right_child: u64</code>
</dt>
<dd>

</dd>
<dt>
<code>
parent: u64</code>
</dt>
<dd>

</dd>
</dl>


</details>

<Link id="0xdee9_critbit_CritbitTree"></Link>

## Struct `CritbitTree`



<pre><code>
<b>struct</b> <Link to="critbit#0xdee9_critbit_CritbitTree">CritbitTree</Link>&lt;V: store&gt; <b>has</b> store
</code></pre>



<details>
<summary>Fields</summary>


<dl>
<dt>
<code>
root: u64</code>
</dt>
<dd>

</dd>
<dt>
<code>
internal_nodes: <Link to="../iota-framework/table#0x2_table_Table">table::Table</Link>&lt;u64, <Link to="critbit#0xdee9_critbit_InternalNode">critbit::InternalNode</Link>&gt;</code>
</dt>
<dd>

</dd>
<dt>
<code>
leaves: <Link to="../iota-framework/table#0x2_table_Table">table::Table</Link>&lt;u64, <Link to="critbit#0xdee9_critbit_Leaf">critbit::Leaf</Link>&lt;V&gt;&gt;</code>
</dt>
<dd>

</dd>
<dt>
<code>
min_leaf: u64</code>
</dt>
<dd>

</dd>
<dt>
<code>
max_leaf: u64</code>
</dt>
<dd>

</dd>
<dt>
<code>
next_internal_node_index: u64</code>
</dt>
<dd>

</dd>
<dt>
<code>
next_leaf_index: u64</code>
</dt>
<dd>

</dd>
</dl>


</details>

<Link id="@Constants_0"></Link>

## Constants


<Link id="0xdee9_critbit_EExceedCapacity"></Link>



<pre><code>
<b>const</b> <Link to="critbit#0xdee9_critbit_EExceedCapacity">EExceedCapacity</Link>: u64 = 2;
</code></pre>



<Link id="0xdee9_critbit_EIndexOutOfRange"></Link>



<pre><code>
<b>const</b> <Link to="critbit#0xdee9_critbit_EIndexOutOfRange">EIndexOutOfRange</Link>: u64 = 7;
</code></pre>



<Link id="0xdee9_critbit_EKeyAlreadyExist"></Link>



<pre><code>
<b>const</b> <Link to="critbit#0xdee9_critbit_EKeyAlreadyExist">EKeyAlreadyExist</Link>: u64 = 4;
</code></pre>



<Link id="0xdee9_critbit_ELeafNotExist"></Link>



<pre><code>
<b>const</b> <Link to="critbit#0xdee9_critbit_ELeafNotExist">ELeafNotExist</Link>: u64 = 5;
</code></pre>



<Link id="0xdee9_critbit_ENullParent"></Link>



<pre><code>
<b>const</b> <Link to="critbit#0xdee9_critbit_ENullParent">ENullParent</Link>: u64 = 8;
</code></pre>



<Link id="0xdee9_critbit_ETreeNotEmpty"></Link>



<pre><code>
<b>const</b> <Link to="critbit#0xdee9_critbit_ETreeNotEmpty">ETreeNotEmpty</Link>: u64 = 3;
</code></pre>



<Link id="0xdee9_critbit_MAX_CAPACITY"></Link>



<pre><code>
<b>const</b> <Link to="critbit#0xdee9_critbit_MAX_CAPACITY">MAX_CAPACITY</Link>: u64 = 9223372036854775807;
</code></pre>



<Link id="0xdee9_critbit_MAX_U64"></Link>



<pre><code>
<b>const</b> <Link to="critbit#0xdee9_critbit_MAX_U64">MAX_U64</Link>: u64 = 18446744073709551615;
</code></pre>



<Link id="0xdee9_critbit_PARTITION_INDEX"></Link>



<pre><code>
<b>const</b> <Link to="critbit#0xdee9_critbit_PARTITION_INDEX">PARTITION_INDEX</Link>: u64 = 9223372036854775808;
</code></pre>



<Link id="0xdee9_critbit_new"></Link>

## Function `new`



<pre><code>
<b>public</b>(<b>friend</b>) <b>fun</b> <Link to="critbit#0xdee9_critbit_new">new</Link>&lt;V: store&gt;(ctx: &<b>mut</b> <Link to="../iota-framework/tx_context#0x2_tx_context_TxContext">tx_context::TxContext</Link>): <Link to="critbit#0xdee9_critbit_CritbitTree">critbit::CritbitTree</Link>&lt;V&gt;
</code></pre>



<details>
<summary>Implementation</summary>


<pre><code>
<b>public</b>(package) <b>fun</b> <Link to="critbit#0xdee9_critbit_new">new</Link>&lt;V: store&gt;(ctx: &<b>mut</b> TxContext): <Link to="critbit#0xdee9_critbit_CritbitTree">CritbitTree</Link>&lt;V&gt; \{
    <Link to="critbit#0xdee9_critbit_CritbitTree">CritbitTree</Link>&lt;V&gt; \{
        root: <Link to="critbit#0xdee9_critbit_PARTITION_INDEX">PARTITION_INDEX</Link>,
        internal_nodes: <Link to="../iota-framework/table#0x2_table_new">table::new</Link>(ctx),
        leaves: <Link to="../iota-framework/table#0x2_table_new">table::new</Link>(ctx),
        min_leaf: <Link to="critbit#0xdee9_critbit_PARTITION_INDEX">PARTITION_INDEX</Link>,
        max_leaf: <Link to="critbit#0xdee9_critbit_PARTITION_INDEX">PARTITION_INDEX</Link>,
        next_internal_node_index: 0,
        next_leaf_index: 0
    }
}
</code></pre>



</details>

<Link id="0xdee9_critbit_size"></Link>

## Function `size`



<pre><code>
<b>public</b>(<b>friend</b>) <b>fun</b> <Link to="critbit#0xdee9_critbit_size">size</Link>&lt;V: store&gt;(tree: &<Link to="critbit#0xdee9_critbit_CritbitTree">critbit::CritbitTree</Link>&lt;V&gt;): u64
</code></pre>



<details>
<summary>Implementation</summary>


<pre><code>
<b>public</b>(package) <b>fun</b> <Link to="critbit#0xdee9_critbit_size">size</Link>&lt;V: store&gt;(tree: &<Link to="critbit#0xdee9_critbit_CritbitTree">CritbitTree</Link>&lt;V&gt;): u64 \{
    <Link to="../iota-framework/table#0x2_table_length">table::length</Link>(&tree.leaves)
}
</code></pre>



</details>

<Link id="0xdee9_critbit_is_empty"></Link>

## Function `is_empty`



<pre><code>
<b>public</b>(<b>friend</b>) <b>fun</b> <Link to="critbit#0xdee9_critbit_is_empty">is_empty</Link>&lt;V: store&gt;(tree: &<Link to="critbit#0xdee9_critbit_CritbitTree">critbit::CritbitTree</Link>&lt;V&gt;): bool
</code></pre>



<details>
<summary>Implementation</summary>


<pre><code>
<b>public</b>(package) <b>fun</b> <Link to="critbit#0xdee9_critbit_is_empty">is_empty</Link>&lt;V: store&gt;(tree: &<Link to="critbit#0xdee9_critbit_CritbitTree">CritbitTree</Link>&lt;V&gt;): bool \{
    <Link to="../iota-framework/table#0x2_table_is_empty">table::is_empty</Link>(&tree.leaves)
}
</code></pre>



</details>

<Link id="0xdee9_critbit_min_leaf"></Link>

## Function `min_leaf`



<pre><code>
<b>public</b> <b>fun</b> <Link to="critbit#0xdee9_critbit_min_leaf">min_leaf</Link>&lt;V: store&gt;(tree: &<Link to="critbit#0xdee9_critbit_CritbitTree">critbit::CritbitTree</Link>&lt;V&gt;): (u64, u64)
</code></pre>



<details>
<summary>Implementation</summary>


<pre><code>
<b>public</b> <b>fun</b> <Link to="critbit#0xdee9_critbit_min_leaf">min_leaf</Link>&lt;V: store&gt;(tree: &<Link to="critbit#0xdee9_critbit_CritbitTree">CritbitTree</Link>&lt;V&gt;): (u64, u64) \{
    <b>assert</b>!(!<Link to="critbit#0xdee9_critbit_is_empty">is_empty</Link>(tree), <Link to="critbit#0xdee9_critbit_ELeafNotExist">ELeafNotExist</Link>);
    <b>let</b> min_leaf = <Link to="../iota-framework/table#0x2_table_borrow">table::borrow</Link>(&tree.leaves, tree.min_leaf);
    <b>return</b> (min_leaf.key, tree.min_leaf)
}
</code></pre>



</details>

<Link id="0xdee9_critbit_max_leaf"></Link>

## Function `max_leaf`



<pre><code>
<b>public</b> <b>fun</b> <Link to="critbit#0xdee9_critbit_max_leaf">max_leaf</Link>&lt;V: store&gt;(tree: &<Link to="critbit#0xdee9_critbit_CritbitTree">critbit::CritbitTree</Link>&lt;V&gt;): (u64, u64)
</code></pre>



<details>
<summary>Implementation</summary>


<pre><code>
<b>public</b> <b>fun</b> <Link to="critbit#0xdee9_critbit_max_leaf">max_leaf</Link>&lt;V: store&gt;(tree: &<Link to="critbit#0xdee9_critbit_CritbitTree">CritbitTree</Link>&lt;V&gt;): (u64, u64) \{
    <b>assert</b>!(!<Link to="critbit#0xdee9_critbit_is_empty">is_empty</Link>(tree), <Link to="critbit#0xdee9_critbit_ELeafNotExist">ELeafNotExist</Link>);
    <b>let</b> max_leaf = <Link to="../iota-framework/table#0x2_table_borrow">table::borrow</Link>(&tree.leaves, tree.max_leaf);
    <b>return</b> (max_leaf.key, tree.max_leaf)
}
</code></pre>



</details>

<Link id="0xdee9_critbit_previous_leaf"></Link>

## Function `previous_leaf`



<pre><code>
<b>public</b> <b>fun</b> <Link to="critbit#0xdee9_critbit_previous_leaf">previous_leaf</Link>&lt;V: store&gt;(tree: &<Link to="critbit#0xdee9_critbit_CritbitTree">critbit::CritbitTree</Link>&lt;V&gt;, key: u64): (u64, u64)
</code></pre>



<details>
<summary>Implementation</summary>


<pre><code>
<b>public</b> <b>fun</b> <Link to="critbit#0xdee9_critbit_previous_leaf">previous_leaf</Link>&lt;V: store&gt;(tree: &<Link to="critbit#0xdee9_critbit_CritbitTree">CritbitTree</Link>&lt;V&gt;, key: u64): (u64, u64) \{
    <b>let</b> (_, <b>mut</b> index) = <Link to="critbit#0xdee9_critbit_find_leaf">find_leaf</Link>(tree, key);
    <b>assert</b>!(index != <Link to="critbit#0xdee9_critbit_PARTITION_INDEX">PARTITION_INDEX</Link>, <Link to="critbit#0xdee9_critbit_ELeafNotExist">ELeafNotExist</Link>);
    <b>let</b> <b>mut</b> ptr = <Link to="critbit#0xdee9_critbit_MAX_U64">MAX_U64</Link> - index;
    <b>let</b> <b>mut</b> parent = <Link to="../iota-framework/table#0x2_table_borrow">table::borrow</Link>(&tree.leaves, index).parent;
    <b>while</b> (parent != <Link to="critbit#0xdee9_critbit_PARTITION_INDEX">PARTITION_INDEX</Link> && <Link to="critbit#0xdee9_critbit_is_left_child">is_left_child</Link>(tree, parent, ptr))\{
        ptr = parent;
        parent = <Link to="../iota-framework/table#0x2_table_borrow">table::borrow</Link>(&tree.internal_nodes, ptr).parent;
    };
    <b>if</b>(parent == <Link to="critbit#0xdee9_critbit_PARTITION_INDEX">PARTITION_INDEX</Link>) \{
        <b>return</b> (0, <Link to="critbit#0xdee9_critbit_PARTITION_INDEX">PARTITION_INDEX</Link>)
    };
    index = <Link to="critbit#0xdee9_critbit_MAX_U64">MAX_U64</Link> - <Link to="critbit#0xdee9_critbit_right_most_leaf">right_most_leaf</Link>(tree, <Link to="../iota-framework/table#0x2_table_borrow">table::borrow</Link>(&tree.internal_nodes, parent).left_child);
    <b>let</b> key = <Link to="../iota-framework/table#0x2_table_borrow">table::borrow</Link>(&tree.leaves, index).key;
    <b>return</b> (key, index)
}
</code></pre>



</details>

<Link id="0xdee9_critbit_next_leaf"></Link>

## Function `next_leaf`



<pre><code>
<b>public</b> <b>fun</b> <Link to="critbit#0xdee9_critbit_next_leaf">next_leaf</Link>&lt;V: store&gt;(tree: &<Link to="critbit#0xdee9_critbit_CritbitTree">critbit::CritbitTree</Link>&lt;V&gt;, key: u64): (u64, u64)
</code></pre>



<details>
<summary>Implementation</summary>


<pre><code>
<b>public</b> <b>fun</b> <Link to="critbit#0xdee9_critbit_next_leaf">next_leaf</Link>&lt;V: store&gt;(tree: &<Link to="critbit#0xdee9_critbit_CritbitTree">CritbitTree</Link>&lt;V&gt;, key: u64): (u64, u64) \{
    <b>let</b> (_, <b>mut</b> index) = <Link to="critbit#0xdee9_critbit_find_leaf">find_leaf</Link>(tree, key);
    <b>assert</b>!(index != <Link to="critbit#0xdee9_critbit_PARTITION_INDEX">PARTITION_INDEX</Link>, <Link to="critbit#0xdee9_critbit_ELeafNotExist">ELeafNotExist</Link>);
    <b>let</b> <b>mut</b> ptr = <Link to="critbit#0xdee9_critbit_MAX_U64">MAX_U64</Link> - index;
    <b>let</b> <b>mut</b> parent = <Link to="../iota-framework/table#0x2_table_borrow">table::borrow</Link>(&tree.leaves, index).parent;
    <b>while</b> (parent != <Link to="critbit#0xdee9_critbit_PARTITION_INDEX">PARTITION_INDEX</Link> && !<Link to="critbit#0xdee9_critbit_is_left_child">is_left_child</Link>(tree, parent, ptr))\{
        ptr = parent;
        parent = <Link to="../iota-framework/table#0x2_table_borrow">table::borrow</Link>(&tree.internal_nodes, ptr).parent;
    };
    <b>if</b>(parent == <Link to="critbit#0xdee9_critbit_PARTITION_INDEX">PARTITION_INDEX</Link>) \{
        <b>return</b> (0, <Link to="critbit#0xdee9_critbit_PARTITION_INDEX">PARTITION_INDEX</Link>)
    };
    index = <Link to="critbit#0xdee9_critbit_MAX_U64">MAX_U64</Link> - <Link to="critbit#0xdee9_critbit_left_most_leaf">left_most_leaf</Link>(tree, <Link to="../iota-framework/table#0x2_table_borrow">table::borrow</Link>(&tree.internal_nodes, parent).right_child);
    <b>let</b> key = <Link to="../iota-framework/table#0x2_table_borrow">table::borrow</Link>(&tree.leaves, index).key;
    <b>return</b> (key, index)
}
</code></pre>



</details>

<Link id="0xdee9_critbit_left_most_leaf"></Link>

## Function `left_most_leaf`



<pre><code>
<b>fun</b> <Link to="critbit#0xdee9_critbit_left_most_leaf">left_most_leaf</Link>&lt;V: store&gt;(tree: &<Link to="critbit#0xdee9_critbit_CritbitTree">critbit::CritbitTree</Link>&lt;V&gt;, root: u64): u64
</code></pre>



<details>
<summary>Implementation</summary>


<pre><code>
<b>fun</b> <Link to="critbit#0xdee9_critbit_left_most_leaf">left_most_leaf</Link>&lt;V: store&gt;(tree: &<Link to="critbit#0xdee9_critbit_CritbitTree">CritbitTree</Link>&lt;V&gt;, root: u64): u64 \{
    <b>let</b> <b>mut</b> ptr = root;
    <b>while</b> (ptr &lt; <Link to="critbit#0xdee9_critbit_PARTITION_INDEX">PARTITION_INDEX</Link>)\{
        ptr = <Link to="../iota-framework/table#0x2_table_borrow">table::borrow</Link>(& tree.internal_nodes, ptr).left_child;
    };
    ptr
}
</code></pre>



</details>

<Link id="0xdee9_critbit_right_most_leaf"></Link>

## Function `right_most_leaf`



<pre><code>
<b>fun</b> <Link to="critbit#0xdee9_critbit_right_most_leaf">right_most_leaf</Link>&lt;V: store&gt;(tree: &<Link to="critbit#0xdee9_critbit_CritbitTree">critbit::CritbitTree</Link>&lt;V&gt;, root: u64): u64
</code></pre>



<details>
<summary>Implementation</summary>


<pre><code>
<b>fun</b> <Link to="critbit#0xdee9_critbit_right_most_leaf">right_most_leaf</Link>&lt;V: store&gt;(tree: &<Link to="critbit#0xdee9_critbit_CritbitTree">CritbitTree</Link>&lt;V&gt;, root: u64): u64 \{
    <b>let</b> <b>mut</b> ptr = root;
    <b>while</b> (ptr &lt; <Link to="critbit#0xdee9_critbit_PARTITION_INDEX">PARTITION_INDEX</Link>)\{
        ptr = <Link to="../iota-framework/table#0x2_table_borrow">table::borrow</Link>(& tree.internal_nodes, ptr).right_child;
    };
    ptr
}
</code></pre>



</details>

<Link id="0xdee9_critbit_insert_leaf"></Link>

## Function `insert_leaf`



<pre><code>
<b>public</b>(<b>friend</b>) <b>fun</b> <Link to="critbit#0xdee9_critbit_insert_leaf">insert_leaf</Link>&lt;V: store&gt;(tree: &<b>mut</b> <Link to="critbit#0xdee9_critbit_CritbitTree">critbit::CritbitTree</Link>&lt;V&gt;, key: u64, value: V): u64
</code></pre>



<details>
<summary>Implementation</summary>


<pre><code>
<b>public</b>(package) <b>fun</b> <Link to="critbit#0xdee9_critbit_insert_leaf">insert_leaf</Link>&lt;V: store&gt;(tree: &<b>mut</b> <Link to="critbit#0xdee9_critbit_CritbitTree">CritbitTree</Link>&lt;V&gt;, key: u64, value: V): u64 \{
    <b>let</b> new_leaf = <Link to="critbit#0xdee9_critbit_Leaf">Leaf</Link>&lt;V&gt;\{
        key,
        value,
        parent: <Link to="critbit#0xdee9_critbit_PARTITION_INDEX">PARTITION_INDEX</Link>,
    };
    <b>let</b> new_leaf_index = tree.next_leaf_index;
    tree.next_leaf_index = tree.next_leaf_index + 1;
    <b>assert</b>!(new_leaf_index &lt; <Link to="critbit#0xdee9_critbit_MAX_CAPACITY">MAX_CAPACITY</Link> - 1, <Link to="critbit#0xdee9_critbit_EExceedCapacity">EExceedCapacity</Link>);
    <Link to="../iota-framework/table#0x2_table_add">table::add</Link>(&<b>mut</b> tree.leaves, new_leaf_index, new_leaf);

    <b>let</b> closest_leaf_index = <Link to="critbit#0xdee9_critbit_get_closest_leaf_index_by_key">get_closest_leaf_index_by_key</Link>(tree, key);

    // Handle the first insertion
    <b>if</b> (closest_leaf_index == <Link to="critbit#0xdee9_critbit_PARTITION_INDEX">PARTITION_INDEX</Link>) \{
        <b>assert</b>!(new_leaf_index == 0, <Link to="critbit#0xdee9_critbit_ETreeNotEmpty">ETreeNotEmpty</Link>);
        tree.root = <Link to="critbit#0xdee9_critbit_MAX_U64">MAX_U64</Link> - new_leaf_index;
        tree.min_leaf = new_leaf_index;
        tree.max_leaf = new_leaf_index;
        <b>return</b> 0
    };

    <b>let</b> closest_key = <Link to="../iota-framework/table#0x2_table_borrow">table::borrow</Link>(&tree.leaves, closest_leaf_index).key;
    <b>assert</b>!(closest_key != key, <Link to="critbit#0xdee9_critbit_EKeyAlreadyExist">EKeyAlreadyExist</Link>);

    // Note that we reserve count_leading_zeros of form u128 for future <b>use</b>
    <b>let</b> <Link to="critbit#0xdee9_critbit">critbit</Link> = 64 - (count_leading_zeros((closest_key ^ key) <b>as</b> u128) - 64);
    <b>let</b> new_mask = 1u64 &lt;&lt; (<Link to="critbit#0xdee9_critbit">critbit</Link> - 1);

    <b>let</b> new_internal_node= <Link to="critbit#0xdee9_critbit_InternalNode">InternalNode</Link> \{
        mask: new_mask,
        left_child: <Link to="critbit#0xdee9_critbit_PARTITION_INDEX">PARTITION_INDEX</Link>,
        right_child: <Link to="critbit#0xdee9_critbit_PARTITION_INDEX">PARTITION_INDEX</Link>,
        parent: <Link to="critbit#0xdee9_critbit_PARTITION_INDEX">PARTITION_INDEX</Link>,
    };
    <b>let</b> new_internal_node_index = tree.next_internal_node_index;
    tree.next_internal_node_index = tree.next_internal_node_index + 1;
    <Link to="../iota-framework/table#0x2_table_add">table::add</Link>(&<b>mut</b> tree.internal_nodes, new_internal_node_index, new_internal_node);

    <b>let</b> <b>mut</b> ptr = tree.root;
    <b>let</b> <b>mut</b> new_internal_node_parent_index = <Link to="critbit#0xdee9_critbit_PARTITION_INDEX">PARTITION_INDEX</Link>;
    // Search position of the new <b>internal</b> node
    <b>while</b> (ptr &lt; <Link to="critbit#0xdee9_critbit_PARTITION_INDEX">PARTITION_INDEX</Link>) \{
        <b>let</b> internal_node = <Link to="../iota-framework/table#0x2_table_borrow">table::borrow</Link>(&tree.internal_nodes, ptr);
        <b>if</b> (new_mask &gt; internal_node.mask) \{
            <b>break</b>
        };
        new_internal_node_parent_index = ptr;
        <b>if</b> (key & internal_node.mask == 0) \{
            ptr = internal_node.left_child;
        } <b>else</b> \{
            ptr = internal_node.right_child;
        };
    };

    // Update the child info of new <b>internal</b> node's parent
    <b>if</b> (new_internal_node_parent_index == <Link to="critbit#0xdee9_critbit_PARTITION_INDEX">PARTITION_INDEX</Link>)\{
        // <b>if</b> the new <b>internal</b> node is root
        tree.root = new_internal_node_index;
    } <b>else</b>\{
        // In another case, we <b>update</b> the child field of the new <b>internal</b> node's parent
        // And the parent field of the new <b>internal</b> node
        <b>let</b> is_left_child = <Link to="critbit#0xdee9_critbit_is_left_child">is_left_child</Link>(tree, new_internal_node_parent_index, ptr);
        <Link to="critbit#0xdee9_critbit_update_child">update_child</Link>(tree, new_internal_node_parent_index, new_internal_node_index, is_left_child);
    };

    // Finally, <b>update</b> the child field of the new <b>internal</b> node
    <b>let</b> is_left_child = new_mask & key == 0;
    <Link to="critbit#0xdee9_critbit_update_child">update_child</Link>(tree, new_internal_node_index, <Link to="critbit#0xdee9_critbit_MAX_U64">MAX_U64</Link> - new_leaf_index, is_left_child);
    <Link to="critbit#0xdee9_critbit_update_child">update_child</Link>(tree, new_internal_node_index, ptr, !is_left_child);

    <b>if</b> (<Link to="../iota-framework/table#0x2_table_borrow">table::borrow</Link>(&tree.leaves, tree.min_leaf).key &gt; key) \{
        tree.min_leaf = new_leaf_index;
    };
    <b>if</b> (<Link to="../iota-framework/table#0x2_table_borrow">table::borrow</Link>(&tree.leaves, tree.max_leaf).key &lt; key) \{
        tree.max_leaf = new_leaf_index;
    };
    new_leaf_index
}
</code></pre>



</details>

<Link id="0xdee9_critbit_find_leaf"></Link>

## Function `find_leaf`



<pre><code>
<b>public</b> <b>fun</b> <Link to="critbit#0xdee9_critbit_find_leaf">find_leaf</Link>&lt;V: store&gt;(tree: &<Link to="critbit#0xdee9_critbit_CritbitTree">critbit::CritbitTree</Link>&lt;V&gt;, key: u64): (bool, u64)
</code></pre>



<details>
<summary>Implementation</summary>


<pre><code>
<b>public</b> <b>fun</b> <Link to="critbit#0xdee9_critbit_find_leaf">find_leaf</Link>&lt;V: store&gt;(tree: & <Link to="critbit#0xdee9_critbit_CritbitTree">CritbitTree</Link>&lt;V&gt;, key: u64): (bool, u64) \{
    <b>if</b> (<Link to="critbit#0xdee9_critbit_is_empty">is_empty</Link>(tree)) \{
        <b>return</b> (<b>false</b>, <Link to="critbit#0xdee9_critbit_PARTITION_INDEX">PARTITION_INDEX</Link>)
    };
    <b>let</b> closest_leaf_index = <Link to="critbit#0xdee9_critbit_get_closest_leaf_index_by_key">get_closest_leaf_index_by_key</Link>(tree, key);
    <b>let</b> closeset_leaf = <Link to="../iota-framework/table#0x2_table_borrow">table::borrow</Link>(&tree.leaves, closest_leaf_index);
    <b>if</b> (closeset_leaf.key != key)\{
        <b>return</b> (<b>false</b>, <Link to="critbit#0xdee9_critbit_PARTITION_INDEX">PARTITION_INDEX</Link>)
    } <b>else</b>\{
        <b>return</b> (<b>true</b>, closest_leaf_index)
    }
}
</code></pre>



</details>

<Link id="0xdee9_critbit_find_closest_key"></Link>

## Function `find_closest_key`



<pre><code>
<b>public</b>(<b>friend</b>) <b>fun</b> <Link to="critbit#0xdee9_critbit_find_closest_key">find_closest_key</Link>&lt;V: store&gt;(tree: &<Link to="critbit#0xdee9_critbit_CritbitTree">critbit::CritbitTree</Link>&lt;V&gt;, key: u64): u64
</code></pre>



<details>
<summary>Implementation</summary>


<pre><code>
<b>public</b>(package) <b>fun</b> <Link to="critbit#0xdee9_critbit_find_closest_key">find_closest_key</Link>&lt;V: store&gt;(tree: & <Link to="critbit#0xdee9_critbit_CritbitTree">CritbitTree</Link>&lt;V&gt;, key: u64): u64 \{
    <b>if</b> (<Link to="critbit#0xdee9_critbit_is_empty">is_empty</Link>(tree)) \{
        <b>return</b> 0
    };
    <b>let</b> closest_leaf_index = <Link to="critbit#0xdee9_critbit_get_closest_leaf_index_by_key">get_closest_leaf_index_by_key</Link>(tree, key);
    <b>let</b> closeset_leaf = <Link to="../iota-framework/table#0x2_table_borrow">table::borrow</Link>(&tree.leaves, closest_leaf_index);
    closeset_leaf.key
}
</code></pre>



</details>

<Link id="0xdee9_critbit_remove_leaf_by_index"></Link>

## Function `remove_leaf_by_index`



<pre><code>
<b>public</b>(<b>friend</b>) <b>fun</b> <Link to="critbit#0xdee9_critbit_remove_leaf_by_index">remove_leaf_by_index</Link>&lt;V: store&gt;(tree: &<b>mut</b> <Link to="critbit#0xdee9_critbit_CritbitTree">critbit::CritbitTree</Link>&lt;V&gt;, index: u64): V
</code></pre>



<details>
<summary>Implementation</summary>


<pre><code>
<b>public</b>(package) <b>fun</b> <Link to="critbit#0xdee9_critbit_remove_leaf_by_index">remove_leaf_by_index</Link>&lt;V: store&gt;(tree: &<b>mut</b> <Link to="critbit#0xdee9_critbit_CritbitTree">CritbitTree</Link>&lt;V&gt;, index: u64): V \{
    <b>let</b> key = <Link to="../iota-framework/table#0x2_table_borrow">table::borrow</Link>(& tree.leaves, index).key;
    <b>if</b> (tree.min_leaf == index) \{
        <b>let</b> (_, index) = <Link to="critbit#0xdee9_critbit_next_leaf">next_leaf</Link>(tree, key);
        tree.min_leaf = index;
    };
    <b>if</b> (tree.max_leaf == index) \{
        <b>let</b> (_, index) = <Link to="critbit#0xdee9_critbit_previous_leaf">previous_leaf</Link>(tree, key);
        tree.max_leaf = index;
    };

    <b>let</b> <b>mut</b> is_left_child_;
    <b>let</b> <Link to="critbit#0xdee9_critbit_Leaf">Leaf</Link>&lt;V&gt; \{key: _, value, parent: removed_leaf_parent_index} = <Link to="../iota-framework/table#0x2_table_remove">table::remove</Link>(&<b>mut</b> tree.leaves, index);

    <b>if</b> (<Link to="critbit#0xdee9_critbit_size">size</Link>(tree) == 0) \{
        tree.root = <Link to="critbit#0xdee9_critbit_PARTITION_INDEX">PARTITION_INDEX</Link>;
        tree.min_leaf = <Link to="critbit#0xdee9_critbit_PARTITION_INDEX">PARTITION_INDEX</Link>;
        tree.max_leaf = <Link to="critbit#0xdee9_critbit_PARTITION_INDEX">PARTITION_INDEX</Link>;
        tree.next_internal_node_index = 0;
        tree.next_leaf_index = 0;
    } <b>else</b> \{
        <b>assert</b>!(removed_leaf_parent_index != <Link to="critbit#0xdee9_critbit_PARTITION_INDEX">PARTITION_INDEX</Link>, <Link to="critbit#0xdee9_critbit_EIndexOutOfRange">EIndexOutOfRange</Link>);
        <b>let</b> removed_leaf_parent = <Link to="../iota-framework/table#0x2_table_borrow">table::borrow</Link>(&tree.internal_nodes, removed_leaf_parent_index);
        <b>let</b> removed_leaf_grand_parent_index = removed_leaf_parent.parent;

        // Note that sibling of the removed leaf can be a leaf or an <b>internal</b> node
        is_left_child_ = <Link to="critbit#0xdee9_critbit_is_left_child">is_left_child</Link>(tree, removed_leaf_parent_index, <Link to="critbit#0xdee9_critbit_MAX_U64">MAX_U64</Link> - index);
        <b>let</b> sibling_index = <b>if</b> (is_left_child_) \{ removed_leaf_parent.right_child }
        <b>else</b> \{ removed_leaf_parent.left_child };

        <b>if</b> (removed_leaf_grand_parent_index == <Link to="critbit#0xdee9_critbit_PARTITION_INDEX">PARTITION_INDEX</Link>) \{
            // Parent of the removed leaf is the tree root
            // Update the parent of the sibling node and and set sibling <b>as</b> the tree root
            <b>if</b> (sibling_index &lt; <Link to="critbit#0xdee9_critbit_PARTITION_INDEX">PARTITION_INDEX</Link>) \{
                // sibling is an <b>internal</b> node
                <Link to="../iota-framework/table#0x2_table_borrow_mut">table::borrow_mut</Link>(&<b>mut</b> tree.internal_nodes, sibling_index).parent = <Link to="critbit#0xdee9_critbit_PARTITION_INDEX">PARTITION_INDEX</Link>;
            } <b>else</b>\{
                // sibling is a leaf
                <Link to="../iota-framework/table#0x2_table_borrow_mut">table::borrow_mut</Link>(&<b>mut</b> tree.leaves, <Link to="critbit#0xdee9_critbit_MAX_U64">MAX_U64</Link> - sibling_index).parent = <Link to="critbit#0xdee9_critbit_PARTITION_INDEX">PARTITION_INDEX</Link>;
            };
            tree.root = sibling_index;
        } <b>else</b> \{
            // grand parent of the removed leaf is a <b>internal</b> node
            // set sibling <b>as</b> the child of the grand parent of the removed leaf
            is_left_child_ = <Link to="critbit#0xdee9_critbit_is_left_child">is_left_child</Link>(tree, removed_leaf_grand_parent_index, removed_leaf_parent_index);
            <Link to="critbit#0xdee9_critbit_update_child">update_child</Link>(tree, removed_leaf_grand_parent_index, sibling_index, is_left_child_);
        };
        <Link to="../iota-framework/table#0x2_table_remove">table::remove</Link>(&<b>mut</b> tree.internal_nodes, removed_leaf_parent_index);
    };
    value
}
</code></pre>



</details>

<Link id="0xdee9_critbit_borrow_mut_leaf_by_index"></Link>

## Function `borrow_mut_leaf_by_index`



<pre><code>
<b>public</b>(<b>friend</b>) <b>fun</b> <Link to="critbit#0xdee9_critbit_borrow_mut_leaf_by_index">borrow_mut_leaf_by_index</Link>&lt;V: store&gt;(tree: &<b>mut</b> <Link to="critbit#0xdee9_critbit_CritbitTree">critbit::CritbitTree</Link>&lt;V&gt;, index: u64): &<b>mut</b> V
</code></pre>



<details>
<summary>Implementation</summary>


<pre><code>
<b>public</b>(package) <b>fun</b> <Link to="critbit#0xdee9_critbit_borrow_mut_leaf_by_index">borrow_mut_leaf_by_index</Link>&lt;V: store&gt;(tree: &<b>mut</b> <Link to="critbit#0xdee9_critbit_CritbitTree">CritbitTree</Link>&lt;V&gt;, index: u64): &<b>mut</b> V \{
    <b>let</b> entry = <Link to="../iota-framework/table#0x2_table_borrow_mut">table::borrow_mut</Link>(&<b>mut</b> tree.leaves, index);
    &<b>mut</b> entry.value
}
</code></pre>



</details>

<Link id="0xdee9_critbit_borrow_leaf_by_index"></Link>

## Function `borrow_leaf_by_index`



<pre><code>
<b>public</b> <b>fun</b> <Link to="critbit#0xdee9_critbit_borrow_leaf_by_index">borrow_leaf_by_index</Link>&lt;V: store&gt;(tree: &<Link to="critbit#0xdee9_critbit_CritbitTree">critbit::CritbitTree</Link>&lt;V&gt;, index: u64): &V
</code></pre>



<details>
<summary>Implementation</summary>


<pre><code>
<b>public</b> <b>fun</b> <Link to="critbit#0xdee9_critbit_borrow_leaf_by_index">borrow_leaf_by_index</Link>&lt;V: store&gt;(tree: & <Link to="critbit#0xdee9_critbit_CritbitTree">CritbitTree</Link>&lt;V&gt;, index: u64): &V \{
    <b>let</b> entry = <Link to="../iota-framework/table#0x2_table_borrow">table::borrow</Link>(&tree.leaves, index);
    &entry.value
}
</code></pre>



</details>

<Link id="0xdee9_critbit_borrow_leaf_by_key"></Link>

## Function `borrow_leaf_by_key`



<pre><code>
<b>public</b> <b>fun</b> <Link to="critbit#0xdee9_critbit_borrow_leaf_by_key">borrow_leaf_by_key</Link>&lt;V: store&gt;(tree: &<Link to="critbit#0xdee9_critbit_CritbitTree">critbit::CritbitTree</Link>&lt;V&gt;, key: u64): &V
</code></pre>



<details>
<summary>Implementation</summary>


<pre><code>
<b>public</b> <b>fun</b> <Link to="critbit#0xdee9_critbit_borrow_leaf_by_key">borrow_leaf_by_key</Link>&lt;V: store&gt;(tree: & <Link to="critbit#0xdee9_critbit_CritbitTree">CritbitTree</Link>&lt;V&gt;, key: u64): &V \{
    <b>let</b> (is_exist, index) = <Link to="critbit#0xdee9_critbit_find_leaf">find_leaf</Link>(tree, key);
    <b>assert</b>!(is_exist, <Link to="critbit#0xdee9_critbit_ELeafNotExist">ELeafNotExist</Link>);
    <Link to="critbit#0xdee9_critbit_borrow_leaf_by_index">borrow_leaf_by_index</Link>(tree, index)
}
</code></pre>



</details>

<Link id="0xdee9_critbit_drop"></Link>

## Function `drop`



<pre><code>
<b>public</b>(<b>friend</b>) <b>fun</b> <Link to="critbit#0xdee9_critbit_drop">drop</Link>&lt;V: drop, store&gt;(tree: <Link to="critbit#0xdee9_critbit_CritbitTree">critbit::CritbitTree</Link>&lt;V&gt;)
</code></pre>



<details>
<summary>Implementation</summary>


<pre><code>
<b>public</b>(package) <b>fun</b> <Link to="critbit#0xdee9_critbit_drop">drop</Link>&lt;V: store + drop&gt;(tree: <Link to="critbit#0xdee9_critbit_CritbitTree">CritbitTree</Link>&lt;V&gt;) \{
    <b>let</b> <Link to="critbit#0xdee9_critbit_CritbitTree">CritbitTree</Link>&lt;V&gt; \{
        root: _,
        internal_nodes,
        leaves,
        min_leaf: _,
        max_leaf: _,
        next_internal_node_index: _,
        next_leaf_index: _,

    } = tree;
    <Link to="../iota-framework/table#0x2_table_drop">table::drop</Link>(internal_nodes);
    <Link to="../iota-framework/table#0x2_table_drop">table::drop</Link>(leaves);
}
</code></pre>



</details>

<Link id="0xdee9_critbit_destroy_empty"></Link>

## Function `destroy_empty`



<pre><code>
<b>public</b>(<b>friend</b>) <b>fun</b> <Link to="critbit#0xdee9_critbit_destroy_empty">destroy_empty</Link>&lt;V: store&gt;(tree: <Link to="critbit#0xdee9_critbit_CritbitTree">critbit::CritbitTree</Link>&lt;V&gt;)
</code></pre>



<details>
<summary>Implementation</summary>


<pre><code>
<b>public</b>(package) <b>fun</b> <Link to="critbit#0xdee9_critbit_destroy_empty">destroy_empty</Link>&lt;V: store&gt;(tree: <Link to="critbit#0xdee9_critbit_CritbitTree">CritbitTree</Link>&lt;V&gt;) \{
    <b>assert</b>!(<Link to="../iota-framework/table#0x2_table_length">table::length</Link>(&tree.leaves) == 0, 0);

    <b>let</b> <Link to="critbit#0xdee9_critbit_CritbitTree">CritbitTree</Link>&lt;V&gt; \{
        root: _,
        leaves,
        internal_nodes,
        min_leaf: _,
        max_leaf: _,
        next_internal_node_index: _,
        next_leaf_index: _
    } = tree;

    <Link to="../iota-framework/table#0x2_table_destroy_empty">table::destroy_empty</Link>(leaves);
    <Link to="../iota-framework/table#0x2_table_destroy_empty">table::destroy_empty</Link>(internal_nodes);
}
</code></pre>



</details>

<Link id="0xdee9_critbit_get_closest_leaf_index_by_key"></Link>

## Function `get_closest_leaf_index_by_key`



<pre><code>
<b>fun</b> <Link to="critbit#0xdee9_critbit_get_closest_leaf_index_by_key">get_closest_leaf_index_by_key</Link>&lt;V: store&gt;(tree: &<Link to="critbit#0xdee9_critbit_CritbitTree">critbit::CritbitTree</Link>&lt;V&gt;, key: u64): u64
</code></pre>



<details>
<summary>Implementation</summary>


<pre><code>
<b>fun</b> <Link to="critbit#0xdee9_critbit_get_closest_leaf_index_by_key">get_closest_leaf_index_by_key</Link>&lt;V: store&gt;(tree: &<Link to="critbit#0xdee9_critbit_CritbitTree">CritbitTree</Link>&lt;V&gt;, key: u64): u64 \{
    <b>let</b> <b>mut</b> ptr = tree.root;
    // <b>if</b> tree is empty, <b>return</b> the patrition index
    <b>if</b>(ptr == <Link to="critbit#0xdee9_critbit_PARTITION_INDEX">PARTITION_INDEX</Link>) <b>return</b> <Link to="critbit#0xdee9_critbit_PARTITION_INDEX">PARTITION_INDEX</Link>;
    <b>while</b> (ptr &lt; <Link to="critbit#0xdee9_critbit_PARTITION_INDEX">PARTITION_INDEX</Link>)\{
        <b>let</b> node = <Link to="../iota-framework/table#0x2_table_borrow">table::borrow</Link>(&tree.internal_nodes, ptr);
        <b>if</b> (key & node.mask == 0)\{
            ptr = node.left_child;
        } <b>else</b> \{
            ptr = node.right_child;
        }
    };
    <b>return</b> (<Link to="critbit#0xdee9_critbit_MAX_U64">MAX_U64</Link> - ptr)
}
</code></pre>



</details>

<Link id="0xdee9_critbit_update_child"></Link>

## Function `update_child`



<pre><code>
<b>fun</b> <Link to="critbit#0xdee9_critbit_update_child">update_child</Link>&lt;V: store&gt;(tree: &<b>mut</b> <Link to="critbit#0xdee9_critbit_CritbitTree">critbit::CritbitTree</Link>&lt;V&gt;, parent_index: u64, new_child: u64, is_left_child: bool)
</code></pre>



<details>
<summary>Implementation</summary>


<pre><code>
<b>fun</b> <Link to="critbit#0xdee9_critbit_update_child">update_child</Link>&lt;V: store&gt;(tree: &<b>mut</b> <Link to="critbit#0xdee9_critbit_CritbitTree">CritbitTree</Link>&lt;V&gt;, parent_index: u64, new_child: u64, is_left_child: bool) \{
    <b>assert</b>!(parent_index != <Link to="critbit#0xdee9_critbit_PARTITION_INDEX">PARTITION_INDEX</Link>, <Link to="critbit#0xdee9_critbit_ENullParent">ENullParent</Link>);
    <b>if</b> (is_left_child) \{
        <Link to="../iota-framework/table#0x2_table_borrow_mut">table::borrow_mut</Link>(&<b>mut</b> tree.internal_nodes, parent_index).left_child = new_child;
    } <b>else</b>\{
        <Link to="../iota-framework/table#0x2_table_borrow_mut">table::borrow_mut</Link>(&<b>mut</b> tree.internal_nodes, parent_index).right_child = new_child;
    };
    <b>if</b> (new_child &gt; <Link to="critbit#0xdee9_critbit_PARTITION_INDEX">PARTITION_INDEX</Link>) \{
        <Link to="../iota-framework/table#0x2_table_borrow_mut">table::borrow_mut</Link>(&<b>mut</b> tree.leaves, <Link to="critbit#0xdee9_critbit_MAX_U64">MAX_U64</Link> - new_child).parent = parent_index;
    } <b>else</b> \{
        <Link to="../iota-framework/table#0x2_table_borrow_mut">table::borrow_mut</Link>(&<b>mut</b> tree.internal_nodes, new_child).parent = parent_index;
    }
}
</code></pre>



</details>

<Link id="0xdee9_critbit_is_left_child"></Link>

## Function `is_left_child`



<pre><code>
<b>fun</b> <Link to="critbit#0xdee9_critbit_is_left_child">is_left_child</Link>&lt;V: store&gt;(tree: &<Link to="critbit#0xdee9_critbit_CritbitTree">critbit::CritbitTree</Link>&lt;V&gt;, parent_index: u64, index: u64): bool
</code></pre>



<details>
<summary>Implementation</summary>


<pre><code>
<b>fun</b> <Link to="critbit#0xdee9_critbit_is_left_child">is_left_child</Link>&lt;V: store&gt;(tree: &<Link to="critbit#0xdee9_critbit_CritbitTree">CritbitTree</Link>&lt;V&gt;, parent_index: u64, index: u64): bool \{
    <Link to="../iota-framework/table#0x2_table_borrow">table::borrow</Link>(&tree.internal_nodes, parent_index).left_child == index
}
</code></pre>



</details>
